---
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Medical Transcription System</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 20px;
			}
			
			.container {
				background: white;
				border-radius: 16px;
				box-shadow: 0 20px 60px rgba(0,0,0,0.3);
				max-width: 600px;
				width: 100%;
				padding: 40px;
			}
			
			h1 {
				color: #333;
				font-size: 28px;
				margin-bottom: 10px;
				text-align: center;
			}
			
			.subtitle {
				color: #666;
				text-align: center;
				margin-bottom: 30px;
				font-size: 14px;
			}
			
			.upload-area {
				border: 3px dashed #667eea;
				border-radius: 12px;
				padding: 40px;
				text-align: center;
				background: #f8f9ff;
				margin-bottom: 20px;
				transition: all 0.3s;
			}
			
			.upload-area:hover {
				border-color: #764ba2;
				background: #f0f1ff;
			}
			
			.upload-area.has-file {
				border-color: #10b981;
				background: #f0fdf4;
			}
			
			input[type="file"] {
				display: none;
			}
			
			.file-label {
				display: inline-block;
				background: #667eea;
				color: white;
				padding: 12px 30px;
				border-radius: 8px;
				cursor: pointer;
				font-weight: 600;
				transition: all 0.3s;
			}
			
			.file-label:hover {
				background: #764ba2;
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
			}
			
			.file-info {
				margin-top: 15px;
				color: #10b981;
				font-weight: 600;
			}
			
			button {
				width: 100%;
				background: #667eea;
				color: white;
				border: none;
				padding: 16px;
				border-radius: 8px;
				font-size: 16px;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s;
				margin-bottom: 10px;
			}
			
			button:hover:not(:disabled) {
				background: #764ba2;
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
			}
			
			button:disabled {
				background: #cbd5e1;
				cursor: not-allowed;
				transform: none;
			}
			
			button.download-btn {
				background: #10b981;
			}
			
			button.download-btn:hover {
				background: #059669;
			}
			
			.status {
				background: #f1f5f9;
				padding: 15px;
				border-radius: 8px;
				margin-top: 20px;
				text-align: center;
				min-height: 60px;
				display: flex;
				align-items: center;
				justify-content: center;
			}
			
			.status.loading {
				background: #dbeafe;
				color: #1e40af;
			}
			
			.status.success {
				background: #d1fae5;
				color: #065f46;
			}
			
			.status.error {
				background: #fee2e2;
				color: #991b1b;
			}
			
			.spinner {
				display: inline-block;
				width: 16px;
				height: 16px;
				border: 2px solid #1e40af;
				border-top-color: transparent;
				border-radius: 50%;
				animation: spin 0.6s linear infinite;
				margin-right: 8px;
			}
			
			@keyframes spin {
				to { transform: rotate(360deg); }
			}
			
			.hidden {
				display: none !important;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>Medical Transcription System</h1>
			<p class="subtitle">Convert audio recordings to formatted medical reports</p>
			
			<div class="upload-area" id="uploadArea">
				<label for="audioInput" class="file-label">
					üìÅ Choose Audio File
				</label>
				<input type="file" id="audioInput" accept="audio/*,video/*,.m4a,.mp3,.wav,.aac,.ogg,.webm,.mp4" multiple="false">
				<div id="fileInfo" class="file-info hidden"></div>
			</div>
			
			<button id="processBtn" disabled>
				üîÑ Process Audio ‚Üí Generate Report
			</button>
			
			<button id="downloadBtn" class="download-btn hidden">
				‚¨áÔ∏è Download PDF Report
			</button>
			
			<div id="status" class="status">
				Select an audio file to begin
			</div>
		</div>

		<script>
			const fileInput = document.getElementById('audioInput');
			const uploadArea = document.getElementById('uploadArea');
			const fileInfo = document.getElementById('fileInfo');
			const processBtn = document.getElementById('processBtn');
			const downloadBtn = document.getElementById('downloadBtn');
			const status = document.getElementById('status');
			
			let selectedFile = null;
			let pdfBlob = null;
			
			// File selection
			fileInput.addEventListener('change', (e) => {
				selectedFile = e.target.files[0];
				if (selectedFile) {
					uploadArea.classList.add('has-file');
					fileInfo.classList.remove('hidden');
					fileInfo.textContent = `‚úì ${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)`;
					processBtn.disabled = false;
					status.className = 'status';
					status.textContent = 'Ready to process!';
					downloadBtn.classList.add('hidden');
				}
			});
			
			// Process button
			processBtn.addEventListener('click', async () => {
				if (!selectedFile) return;
				
				processBtn.disabled = true;
				downloadBtn.classList.add('hidden');
				
				try {
					// Step 1: Transcribe
					status.className = 'status loading';
					status.innerHTML = '<span class="spinner"></span> Step 1/3: Transcribing audio...';
					
					const formData = new FormData();
					formData.append('audio', selectedFile);
					
					const transcribeRes = await fetch('/api/transcribe', {
						method: 'POST',
						body: formData
					});
					
					if (!transcribeRes.ok) throw new Error('Transcription failed');
					const { transcript } = await transcribeRes.json();

					console.log("=== TRANSCRIPT ===");
					console.log(transcript);
					
					// Step 2: Generate report
					status.innerHTML = '<span class="spinner"></span> Step 2/3: Generating report with AI...';
					
					const reportRes = await fetch('/api/generate-report', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ transcript })
					});
					
					if (!reportRes.ok) throw new Error('Report generation failed');
					const { report } = await reportRes.json();
					console.log("\n=== REPORT ===");
					console.log(report);
					// Step 3: Create PDF
					status.innerHTML = '<span class="spinner"></span> Step 3/3: Creating PDF...';
					
					const pdfRes = await fetch('/api/create-pdf', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ report })
					});
					
					if (!pdfRes.ok) throw new Error('PDF creation failed');
					pdfBlob = await pdfRes.blob();
					
					// Success!
					status.className = 'status success';
					status.textContent = '‚úÖ Report generated successfully! Click below to download.';
					downloadBtn.classList.remove('hidden');
					processBtn.disabled = false;
					
				} catch (error) {
					status.className = 'status error';
					status.textContent = `‚ùå Error: ${error.message}`;
					processBtn.disabled = false;
				}
			});
			
			// Download button
			downloadBtn.addEventListener('click', () => {
				if (!pdfBlob) return;
				
				const url = URL.createObjectURL(pdfBlob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `medical-report-${Date.now()}.pdf`;
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
				URL.revokeObjectURL(url);
				
				status.className = 'status success';
				status.textContent = '‚úÖ PDF downloaded! Check your Downloads folder.';
			});
		</script>
	</body>
</html>